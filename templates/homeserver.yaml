# Synapse Homeserver Configuration
# Replace all {{PLACEHOLDER}} values with your actual configuration

# Server name - This is your Matrix domain (e.g., matrix.example.com)
server_name: "{{MATRIX_DOMAIN}}"

# Public base URL for client API
public_baseurl: "https://{{MATRIX_DOMAIN}}/"

# Listeners
listeners:
  # Client API
  - port: 8008
    tls: false  # TLS termination handled by reverse proxy
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation]
        compress: false

# Database configuration
database:
  name: psycopg2
  args:
    user: synapse
    password: "{{POSTGRES_PASSWORD}}"  # MUST match POSTGRES_PASSWORD in .env
    database: synapse
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 10

# Media storage
media_store_path: "/data/media_store"
max_upload_size: "50M"
max_image_pixels: "32M"

# Registration
# Disabled by default - use MAS for user registration
enable_registration: false
registration_shared_secret: "{{SYNAPSE_REGISTRATION_SHARED_SECRET}}"

# Allow guest access
allow_guest_access: false

# Matrix Authentication Service (MAS) integration (Synapse 1.136+)
# Replaces deprecated experimental_features.msc3861
matrix_authentication_service:
  enabled: true
  # Internal endpoint where Synapse contacts MAS
  endpoint: "http://mas:8080"
  # Shared secret - MUST match `matrix.secret` in MAS config
  secret: "ThisTokenIsStaticallyConfiguredAndShouldNotBeUsedInProduction"

# Experimental features
experimental_features:
  # Enable QR code login (requires Synapse 1.106+)
  # Transfers crypto identity without needing password/passphrase
  msc4108_enabled: true
  msc3882_enabled: true

  # Bridge encryption features (experimental)
  # NOTE: As of Synapse 1.144.0, MSC4190 has compatibility issues with MAS
  # Keep these enabled for future compatibility, but bridges should disable encryption for now
  msc4190_enabled: true
  msc3202_device_masquerading: true
  msc3202_transaction_extensions: true
  msc2409_to_device_messages_enabled: true

# Signing Keys
signing_key_path: "/data/{{MATRIX_DOMAIN}}.signing.key"

# Trusted key servers for federation
trusted_key_servers:
  - server_name: "matrix.org"

# Logging
log_config: "/data/{{MATRIX_DOMAIN}}.log.config"

# Rate limiting
rc_message:
  per_second: 0.2
  burst_count: 10

rc_registration:
  per_second: 0.17
  burst_count: 3

rc_login:
  address:
    per_second: 0.17
    burst_count: 3
  account:
    per_second: 0.17
    burst_count: 3
  failed_attempts:
    per_second: 0.17
    burst_count: 3

# Federation settings
# Adjust based on your federation requirements
federation_domain_whitelist: []  # Empty = allow all
# federation_domain_whitelist:
#   - matrix.org
#   - example.com

# Uncomment to disable federation entirely
# federation_enabled: false

# URL preview settings (optional)
url_preview_enabled: false
# url_preview_ip_range_blacklist:
#   - '127.0.0.0/8'
#   - '10.0.0.0/8'
#   - '172.16.0.0/12'
#   - '192.168.0.0/16'
#   - '100.64.0.0/10'
#   - '169.254.0.0/16'
#   - '::1/128'
#   - 'fe80::/64'
#   - 'fc00::/7'

# Email notifications (optional)
# email:
#   smtp_host: "smtp.example.com"
#   smtp_port: 587
#   smtp_user: "noreply@example.com"
#   smtp_pass: "password"
#   require_transport_security: true
#   notif_from: "Matrix <noreply@example.com>"
#   app_name: "Matrix"

# Push notification settings
# push:
#   include_content: true

# Room directory
room_prejoin_state:
  disable_default_event_types: false

# Security
suppress_key_server_warning: true

# Report stats (optional - helps Matrix.org understand network)
report_stats: false

# Additional modules (optional)
# modules: []

# Worker mode (for scaling)
# This is a single-process configuration
# For high-traffic servers, consider worker mode
# https://element-hq.github.io/synapse/latest/workers.html

# Caching
caches:
  global_factor: 1.0
  per_cache_factors: {}

# Enable metrics for monitoring (optional)
# enable_metrics: true
# metrics_port: 9000

# Appservice Configuration (optional - for bridges)
# Uncomment and configure after setting up bridges
# See BRIDGE_SETUP_GUIDE.md for detailed setup instructions
# app_service_config_files:
#   - /appservices/doublepuppet.yaml
#   - /bridges/whatsapp/config/registration.yaml
#   - /bridges/signal/config/registration.yaml
#   - /bridges/telegram/config/registration.yaml

# ============================================
# Important Notes:
# ============================================
#
# 1. {{MATRIX_DOMAIN}}: Replace with your Matrix server domain
#
# 2. {{POSTGRES_PASSWORD}}: MUST match the password in .env
#    If you change the password in .env, you MUST update it here!
#
# 3. {{SYNAPSE_REGISTRATION_SHARED_SECRET}}: Used for creating admin users
#    Keep this secret and secure!
#
# 4. Matrix Authentication Service: Synapse 1.136+ uses stable MAS integration
#    The 'secret' in matrix_authentication_service MUST match 'matrix.secret' in MAS config
#    Old experimental_features.msc3861 is deprecated and removed in Synapse 1.137+
#
# 5. Signing Key: Will be auto-generated on first run if not present
#
# 6. Log Config: Will be auto-generated on first run if not present
#
# ============================================
